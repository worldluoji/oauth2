# OAuth2 Security
## 1. CSRF攻击

<img src="./CSRF攻击过程.webp" />

恶意软件让浏览器向已完成用户身份认证的网站发起请求，并执行有害的操作，就是跨站请求伪造攻击。
比如，攻击者A注册登录，截取了自己的授权码codeA，便在构造了一个使用codeA的攻击页面，
里面包含模拟代码，来诱导正常用户G点击。

此时G已经登录，如果点击了A构造的恶意页面，那么那么后面换取授权的访问令牌 access_token，以及通过 accces_token 获取的信息就都是攻击者软件 A 的了。

如果G做的操作是和微信绑定，那么其实是和A的微信绑定了，A的微信就可以登录G的账号。

### 如何避免这种攻击呢？
方法也很简单，实际上 OAuth 2.0 中也有这样的建议，就是**使用 state 参数**，它是一个随机值的参数。

当三方软件请求授权码的时候附带一个自己生成 state 参数值，
同时授权服务也要按照规则将这个随机的 state 值跟授权码 code 一起返回给三方软件。

这样，当三方软件接收到授权码的时候，就要做 state 参数值的比对校验，
如果相同就继续流程，否则直接拒绝后续流程。

因为state是一个随机数，而且在生成时就遵从了被“猜中”的概率要极小的建议。

<br>

## 2. XSS攻击
XSS 攻击的主要手段是将恶意脚本注入到请求的输入中，攻击者可以通过注入的恶意脚本来进行攻击行为，
比如搜集数据等。

受保护资源服务就需要对 XSS 漏洞做修复，而具体的修复方法跟其它网站防御 XSS 类似，
最简单的方法就是对此类非法信息做转义过滤，比如对包含`<script>、<img>、<a>`等标签的信息进行转义过滤。

<br>

## 3. 水平越权
水平越权是指，在请求受保护资源服务数据的时候，服务端应用程序未校验这条数据是否归属于当前授权的请求用户。
这需要加强安全意识，对相应的数据归属做校验。

<br>

## 4. 应该使用HTTPS
在使用 OAuth 2.0 的流程中，我们的 HTTP 通信要使用 HTTPS 协议来保护数据传输的安全性。
这是因为 OAuth 2.0 支持的 bearer 令牌类型，也就是任意字符串格式的令牌，并没有提供且没有要求使用信息签名的机制。

另一方面，虽然JWT令牌加了密，但 JWT 跟 OAuth 2.0 并没有直接关系，它只是一种结构化的信息存储，
可以被用在除了 OAuth 2.0 以外的任何地方。

比如，重置密码的时候，会给你的邮箱发送一个链接，这个链接就需要能够标识出用户是谁、不能篡改、有效期 5 分钟，这些特征都跟 JWT 相符合。也就是说，JWT 并不是 OAuth 2.0 协议规范所涵盖的内容。

<br>

## 5. 总结
- 1）一定要启用 https；
- 2）一定要把 app_secret 放在后端；
- 3）三方软件收到 授权code 时，一定要校验 state 的值
- 4）注意对JS标签的校验
- 5）注意对权限的校验

只有第三方软件开发者和平台方的研发人员共同保有较高的安全意识，
才能让“安全的墙”垒得越来越高，让攻击者的成本越来越高。
因为安全的本质就是成本问题。

